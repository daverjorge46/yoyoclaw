name: GateClaw Trust Gate (v0)

on:
  issues:
    types: [opened, reopened]
  pull_request_target:
    types: [opened, reopened]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  gate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (for allowlist)
        uses: actions/checkout@v4

      - name: Enforce GateClaw trust gate
        uses: actions/github-script@v7
        env:
          INTAKE_FORM_URL: "https://forms.gle/RkANccxPRtQ32fhk7"
          ALLOWLIST_FILE: ".github/trust-gate-allowlist.txt"
        with:
          script: |
            const fs = require('fs');

            const isIssue = !!context.payload.issue;
            const item = isIssue ? context.payload.issue : context.payload.pull_request;
            const author = item.user.login;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            let allow = new Set();
            try {
              const raw = fs.readFileSync(process.env.ALLOWLIST_FILE, 'utf8');
              raw.split('\n')
                .map(line => line.trim())
                .filter(line => line && !line.startsWith('#'))
                .forEach(user => allow.add(user.toLowerCase()));
            } catch (err) {
              core.warning(`Allowlist file missing/unreadable: ${err.message}`);
            }

            let trusted = allow.has(author.toLowerCase());

            if (!trusted) {
              try {
                const perm = await github.rest.repos.getCollaboratorPermissionLevel({
                  owner,
                  repo,
                  username: author,
                });
                const level = perm.data.permission;
                if (['admin', 'maintain', 'write', 'triage'].includes(level)) {
                  trusted = true;
                }
              } catch {
                // Not a collaborator, continue as untrusted.
              }
            }

            core.info(`author=${author}, trusted=${trusted}`);
            if (trusted) return;

            const message = [
              `Hey @${author} ðŸ‘‹ thanks for contributing.`,
              '',
              'To reduce spam/noise and protect maintainer time, this repository currently accepts new Issues/PRs from trusted contributors only.',
              '',
              `Request access here: ${process.env.INTAKE_FORM_URL}`,
              '',
              'Once approved, you can reopen/resubmit immediately.'
            ].join('\n');

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: item.number,
              body: message,
            });

            if (isIssue) {
              await github.rest.issues.update({
                owner,
                repo,
                issue_number: item.number,
                state: 'closed',
              });
            } else {
              await github.rest.pulls.update({
                owner,
                repo,
                pull_number: item.number,
                state: 'closed',
              });
            }
