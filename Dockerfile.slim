# OpenClaw Multi-stage Optimized Dockerfile
# Target: < 500MB final image
#
# Build: docker build -f Dockerfile.slim -t openclaw:slim .
# Analyze: ./scripts/docker-image-analyze.sh openclaw:slim

# ============================================
# Stage 1: Build stage (full tooling)
# ============================================
FROM node:22-bookworm AS builder

# Install Bun (required for build scripts)
RUN curl -fsSL https://bun.sh/install | bash
ENV PATH="/root/.bun/bin:${PATH}"

RUN corepack enable

WORKDIR /app

# Copy package files first for better cache
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml .npmrc ./
COPY ui/package.json ./ui/package.json
COPY patches ./patches
COPY scripts ./scripts

# Install all dependencies (including dev) for building
RUN pnpm install --frozen-lockfile

# Copy source and build
COPY . .
RUN OPENCLAW_A2UI_SKIP_MISSING=1 pnpm build

# Build UI
ENV OPENCLAW_PREFER_PNPM=1
RUN pnpm ui:build

# ============================================
# Stage 2: Production dependencies only
# ============================================
FROM node:22-bookworm-slim AS prod-deps

RUN corepack enable
WORKDIR /app
ARG OPENCLAW_PRUNE_EXTRA=0

# Copy package files
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml .npmrc ./
COPY patches ./patches

# Install production dependencies only for the root CLI package.
# In a pnpm workspace this avoids pulling runtime deps for every workspace package.
RUN pnpm install --frozen-lockfile --prod --ignore-scripts --filter openclaw...

# Remove large optional binaries that aren't needed in most deployments
# These are primarily for local LLM inference
RUN rm -rf node_modules/.pnpm/@node-llama-cpp* 2>/dev/null || true && \
    rm -rf node_modules/.pnpm/*node-llama-cpp* 2>/dev/null || true && \
    rm -rf node_modules/.pnpm/*cuda* 2>/dev/null || true && \
    rm -rf node_modules/.pnpm/*vulkan* 2>/dev/null || true && \
    rm -rf node_modules/.pnpm/*tensorflow* 2>/dev/null || true && \
    rm -rf node_modules/.pnpm/*linux-x64-musl* 2>/dev/null || true && \
    rm -rf node_modules/.pnpm/*linuxmusl* 2>/dev/null || true && \
    rm -rf node_modules/.pnpm/typescript@* 2>/dev/null || true && \
    find node_modules -type f -name "*.map" -delete && \
    find node_modules -type d \( -name "__tests__" -o -name "test" -o -name "tests" -o -name "docs" -o -name "examples" -o -name "benchmark" \) -prune -exec rm -rf '{}' +

# Optional aggressive prune for channel-specific SDKs.
# Enable with: --build-arg OPENCLAW_PRUNE_EXTRA=1
RUN if [ "$OPENCLAW_PRUNE_EXTRA" = "1" ]; then \
      rm -rf node_modules/.pnpm/@larksuiteoapi+node-sdk@* 2>/dev/null || true; \
      rm -rf node_modules/.pnpm/@line+bot-sdk@* 2>/dev/null || true; \
      rm -rf node_modules/.pnpm/@slack+bolt@* 2>/dev/null || true; \
      rm -rf node_modules/.pnpm/@slack+web-api@* 2>/dev/null || true; \
      rm -rf node_modules/.pnpm/playwright-core@* 2>/dev/null || true; \
    fi

# ============================================
# Stage 3: Runtime image (minimal)
# ============================================
FROM node:22-slim AS runtime

WORKDIR /app

# Runtime only: remove package-manager/tooling payload from the Node base image.
RUN rm -rf \
    /usr/local/lib/node_modules/npm \
    /usr/local/lib/node_modules/corepack \
    /usr/local/include/node \
    /usr/local/share/doc \
    /usr/local/share/man \
    /usr/local/share/systemtap

# Copy production node_modules from prod-deps stage
COPY --from=prod-deps --chown=1000:1000 /app/node_modules ./node_modules

# Copy built artifacts from builder
COPY --from=builder --chown=1000:1000 /app/dist ./dist

# Copy runtime files
COPY --chown=1000:1000 openclaw.mjs ./
COPY --chown=1000:1000 package.json ./
COPY --chown=1000:1000 extensions ./extensions

ENV NODE_ENV=production

# Security: run as non-root
USER node

# Gateway default command
CMD ["node", "openclaw.mjs", "gateway", "--allow-unconfigured"]
