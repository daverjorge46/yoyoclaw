services:
  gateway:
    image: openclaw/gateway:latest  # Pulls latest patched
    build: .  # Builds if needed (ARM-native)
    ports:
      - "127.0.0.1:18789:18789"  # Localhost-only (safer than "18789:18789")
    volumes:
      - /Users/home/GitHub/openclaw/config:/app/config  # Use ABSOLUTE paths on Mac (replace /full/path/to/openclaw/)
      - /Users/home/GitHub/openclaw/workspace:/app/workspace
      - /Users/home/GitHub/openclaw/credentials:/root/.openclaw/credentials
    environment:
      - NODE_ENV=production
      - PORT=18789
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN}
      - OLLAMA_BASE=http://host.docker.internal:11434
      - OLLAMA_API_KEY=ollama-local
    # Install dependencies on startup (yt-dlp, ffmpeg, jq)
    # Note: Container runs as non-root 'node' user, so we use sudo or install at build time
    user: "0:0"  # Temporarily run as root to install packages
    command: >
      sh -c "
        apt-get update -qq 2>/dev/null &&
        apt-get install -y -qq ffmpeg jq python3-pip curl sudo 2>/dev/null &&
        pip3 install --break-system-packages -q yt-dlp 2>/dev/null || true &&
        chown -R node:node /app &&
        su node -c 'node dist/index.js gateway --allow-unconfigured --port 18789'
      "
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G  # Cap to protect your MacBook
    # NO privileged: true â€“ keeps it sandboxed (no host root/shell)

  # models:  # Optional: API proxy (add local Ollama later)
  #   image: openclaw/models:latest
  #   environment:
  #     - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
  #     - OPENAI_API_KEY=${OPENAI_API_KEY}
  #   restart: unless-stopped
